{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport { BasePopScene } from \"../../base/BasePopScene\";\r\nimport GameLogicProcessingManager_Als from \"../../../games/GameLogicProcessingManager\";\r\nimport { PlayerDataManager_Als } from \"../../../common/GameDataManager\";\r\nimport { MiniManeger_Als } from \"../../../minigame/MiniManeger\";\r\nimport { LotteryPopScene } from \"./LotteryPopScene\";\r\nvar LotteryScene = (function (_super) {\r\n    tslib_1.__extends(LotteryScene, _super);\r\n    function LotteryScene(data) {\r\n        var _this = _super.call(this, data) || this;\r\n        _this.className_key = \"LotteryScene\";\r\n        _this.versionRandom = \"\";\r\n        _this.lotteryData = [\r\n            { \"id\": \"3\", \"item\": \"0|0\", \"des\": \"再来一次\", \"worth\": \"2000\" },\r\n            { \"id\": \"4\", \"item\": \"2|200\", \"des\": \"200金币\", \"worth\": \"1000\" },\r\n            { \"id\": \"5\", \"item\": \"1|6\", \"des\": \"6体力\", \"worth\": \"500\" },\r\n            { \"id\": \"6\", \"item\": \"0|0\", \"des\": \"感谢参与\", \"worth\": \"1500\" },\r\n            { \"id\": \"7\", \"item\": \"2|150\", \"des\": \"150金币\", \"worth\": \"1000\" },\r\n            { \"id\": \"8\", \"item\": \"1|4\", \"des\": \"4体力\", \"worth\": \"500\" },\r\n            { \"id\": \"1\", \"item\": \"2|50\", \"des\": \"50金币\", \"worth\": \"2000\" },\r\n            { \"id\": \"2\", \"item\": \"1|2\", \"des\": \"2体力\", \"worth\": \"1500\" }\r\n        ];\r\n        _this.isLotterying = false;\r\n        _this.tn = 5;\r\n        _this.totalNum = 8;\r\n        _this.versionRandom = \"?v=\" + Date.now();\r\n        _this.skin = \"game/uiView/lottery/LotteryScene.json\";\r\n        return _this;\r\n    }\r\n    LotteryScene.prototype.getLotteryConfig = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                return [2, new Promise(function (resolve) {\r\n                        Laya.loader.load(\"resource/assets/config/LotteryConfig.json\" + _this.versionRandom, Laya.Handler.create(_this, function (data) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                this.lotteryData = Utils.copy(data);\r\n                                resolve(data);\r\n                                return [2];\r\n                            });\r\n                        }); }));\r\n                    })];\r\n            });\r\n        });\r\n    };\r\n    LotteryScene.prototype.initLottery = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var i, len;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, this.getLotteryConfig()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        if (!this.weightArr) {\r\n                            this.weightArr = [];\r\n                            for (i = 0, len = this.lotteryData.length; i < len; i++) {\r\n                                this.weightArr.push(parseInt(this.lotteryData[i].worth));\r\n                            }\r\n                        }\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    LotteryScene.prototype.getRandomByWeightArr = function (oArr) {\r\n        var sum = 0;\r\n        var rand = 0;\r\n        var result = 0;\r\n        for (var i in oArr) {\r\n            sum += Number(oArr[i]);\r\n        }\r\n        for (var i in oArr) {\r\n            rand = Math.floor(Math.random() * sum + 1);\r\n            if (oArr[i] >= rand) {\r\n                result = Number(i);\r\n                break;\r\n            }\r\n            else {\r\n                sum -= oArr[i];\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n    LotteryScene.prototype.onLottery = function () {\r\n        if (this.isLotterying) {\r\n            return;\r\n        }\r\n        ;\r\n        this.isLotterying = true;\r\n        var awardIndex = this.getRandomByWeightArr(this.weightArr);\r\n        this.startLottery(awardIndex);\r\n        PlayerDataManager_Als.getInstance().stPlayerDataBase.nLotteryTimeLast = Date.now();\r\n        PlayerDataManager_Als.getInstance().stPlayerDataBase.nLotteryCount += 1;\r\n        PlayerDataManager_Als.getInstance().SaveData();\r\n    };\r\n    LotteryScene.prototype.clickLottery = function () {\r\n        var _this = this;\r\n        if (this.img_video.visible) {\r\n            if (this.isLotterying) {\r\n                return;\r\n            }\r\n            ;\r\n            MiniManeger_Als.instance.playViderAd({\r\n                successFun: function () {\r\n                    _this.onLottery();\r\n                }\r\n            });\r\n        }\r\n        else {\r\n            this.onLottery();\r\n        }\r\n    };\r\n    LotteryScene.prototype.startLottery = function (index) {\r\n        var _this = this;\r\n        this.img_lottery.rotation = this.img_lottery.rotation % 360;\r\n        var ro = Utils.random(-10, 10);\r\n        Laya.Tween.clearAll(this.img_lottery);\r\n        console.log(index);\r\n        var roa = -index * 360 / this.totalNum - (360 / this.totalNum / 2) + 3600;\r\n        var timeDelay = 1400 * this.tn;\r\n        Laya.Tween.to(this.img_lottery, { rotation: roa }, timeDelay, Laya.Ease.strongInOut, Laya.Handler.create(this, function () {\r\n            Laya.Tween.clearAll(_this.img_lottery);\r\n            _this.isLotterying = false;\r\n            var data = _this.lotteryData[index];\r\n            _this.checkLottery(data);\r\n        }));\r\n    };\r\n    LotteryScene.prototype.checkCanFreeLottery = function () {\r\n        var nCurTime = GameLogicProcessingManager_Als.GetCurTime();\r\n        if (Utils.judgeIsOnTheSameDay(PlayerDataManager_Als.getInstance().stPlayerDataBase.nLotteryTimeLast, nCurTime)) {\r\n            if (PlayerDataManager_Als.getInstance().stPlayerDataBase.nLotteryCount == 0) {\r\n                this.img_video.visible = false;\r\n            }\r\n            else {\r\n                this.img_video.visible = true;\r\n            }\r\n        }\r\n        else {\r\n            this.img_video.visible = false;\r\n        }\r\n    };\r\n    LotteryScene.prototype.checkLottery = function (data) {\r\n        console.log(\"lottery>>>\", data);\r\n        var id = data.id;\r\n        if (id == 3 + '') {\r\n            this.onLottery();\r\n        }\r\n        else if (id == 6 + '') {\r\n            TipsManager.getInstance().showDefaultTips(\"感谢参与\");\r\n        }\r\n        else {\r\n            var arr = data.item.split(\"|\");\r\n            var type = arr[0];\r\n            var count = arr[1];\r\n            ViewManager.getInstance().showView(LotteryPopScene, { type: type, count: count });\r\n        }\r\n        this.img_video.visible = true;\r\n    };\r\n    LotteryScene.prototype.initMiniGame = function () {\r\n    };\r\n    LotteryScene.prototype.initView = function () {\r\n        this.checkCanFreeLottery();\r\n        this.initLottery();\r\n    };\r\n    LotteryScene.prototype.addEvent = function () {\r\n        this.btn_lottery.on(Laya.Event.CLICK, this, this.clickLottery);\r\n        this.btn_close.on(Laya.Event.CLICK, this, this.removeSelf);\r\n    };\r\n    LotteryScene.prototype.removeEvent = function () {\r\n        this.btn_lottery.off(Laya.Event.CLICK, this, this.clickLottery);\r\n        this.btn_close.off(Laya.Event.CLICK, this, this.removeSelf);\r\n    };\r\n    LotteryScene.prototype.removeSelf = function () {\r\n        if (this.isLotterying) {\r\n            return;\r\n        }\r\n        ;\r\n        return _super.prototype.removeSelf.call(this);\r\n    };\r\n    LotteryScene.prototype.onRemoved = function () {\r\n        _super.prototype.onRemoved.call(this);\r\n        this.removeEvent();\r\n    };\r\n    return LotteryScene;\r\n}(BasePopScene));\r\nexport { LotteryScene };\r\n",
  "references": [
    "E:/laya/project/laya_girl_ts_wecat_git/src/script/views/base/BasePopScene.ts",
    "E:/laya/project/laya_girl_ts_wecat_git/src/script/games/GameLogicProcessingManager.ts",
    "E:/laya/project/laya_girl_ts_wecat_git/src/script/common/GameDataManager.ts",
    "E:/laya/project/laya_girl_ts_wecat_git/src/script/minigame/MiniManeger.ts",
    "E:/laya/project/laya_girl_ts_wecat_git/src/script/views/game/lottery/LotteryPopScene.ts"
  ]
}
